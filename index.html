<!DOCTYPE html>
<!-- xlsx.js (C) 2013-present  SheetJS http://sheetjs.com 
		https://github.com/SheetJS/js-xlsx
		https://stuk.github.io/jszip/
-->
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>Search SUN Spreadsheet</title>
<style>
		 body {
			font-family: "SUN7.21";
			width = 600px;
		}
		
		 h3 {	    
			 margin-block-start: .3em;
			 margin-block-end: .3em;
			 margin-inline-start: 0px;
			 margin-inline-end: 0px;
			 text-align: center;
		}

 
	div.filetable {
		width: 100%
	}	
	
	label#xrefclear {
		float: left;
		width: 30%
	}	
	
	input#xrefclear {
		float: right;
	}	
	

		table.xreftable {
			 border-width: 1px;
			 border-spacing: 0;
			 border-style: outset;
			 border-color: black;
			 border-collapse: separate; 
		/* 	border-collapse:collapse; */
			 background-color: white; 
			 font-size: 14px;
			 font-family: var(--sun-font);
			 table-layout: fixed;
			 margin-bottom: 15px;
			 width: 100%; 
			 empty-cells: show;
		}

		.unicol{
			width: 50px;
			color: blue;
			border-width: 1px;
			padding: 1px;
			border-style: inset;
			border-color: lightblue;
			font-size: 14px;
			text-align: right; 
		}
		
		.xfonticon {
			font-size: 32px;
			font-family: var(--sun-font);
			color: blue;
			border-width: 1px;
			padding: 1px;
			width: 100px;
		}
				 
	 .xreftable td:not(.unicol), .xreftable th:not(.unicol), .xreftable td:not(.fonticon), .xreftable th:not(.fonticon) {
			 border-width: 1px;
			 padding: 1px;
			 border-style: inset;
			 border-color: lightblue;
			 font-size: 14px;
			 text-align: right; 

			white-space: -o-pre-wrap; 
			word-wrap: break-word;
			white-space: pre-wrap; 
			white-space: -moz-pre-wrap; 
			white-space: -pre-wrap; 
			min-width: 50px;
		/*	width: auto;*/
		 }

		 .xreftable td.fonticon {
			font-size: 32px;
			font-family: var(--sun-font);
			color: blue;
			border-width: 1px;
			padding: 1px;
			width: 100px;
		}
		 .xreftable th.fonticon {

			color: blue;
			border-width: 1px;
			padding: 1px;
			width: 100px;
		}

		 
			 /*Table Even Rows Styles*/
		 .xreftable tbody, .xreftable tr:nth-child(even){
			 background-color: #efefef;
		 }

			 /*Table ODD Rows Styles*/
		 .xreftable tbody, .xreftable tr:nth-child(odd){
			 background-color: #dfdfdf;
		 }

			 /*Table Row HOver Style*/
		 .xreftable table, .xreftable tbody, .xreftable tr:hover{
			 background-color: #ffffd8;
		 }


		.uerror {
			  color: red;
		 }
		
		 

		:root {
			--sun-font: "SUN7.22";
		}

		#drop{
			border:2px dashed #bbb;
			border-radius:5px;
			padding:5px;
			text-align:center;
			font:20pt bold,"Vollkorn";color:#bbb
		}
		

/* The Modal (background) */
.modal {
  display: none; /* Hidden by default */
  position: fixed; /* Stay in place */
  z-index: 1; /* Sit on top */
  padding-top: 100px; /* Location of the box */
  left: 0;
  top: 0;
  width: 100%; /* Full width */
  height: 100%; /* Full height */
  overflow: auto; /* Enable scroll if needed */
  background-color: rgb(0,0,0); /* Fallback color */
  background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
}

/* Modal Content */
.modal-content {
  position: relative;
  background-color: #fefefe;
  margin: auto;
  padding: 0;
  border: 1px solid #888;
  border-radius:5px;
  width: 200px;;
  box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2),0 6px 20px 0 rgba(0,0,0,0.19);
  -webkit-animation-name: animatetop;
  -webkit-animation-duration: 0.4s;
  animation-name: animatetop;
  animation-duration: 0.4s
}

/* Add Animation */
@-webkit-keyframes animatetop {
  from {top:-300px; opacity:0} 
  to {top:0; opacity:1}
}

@keyframes animatetop {
  from {top:-300px; opacity:0}
  to {top:0; opacity:1}
}

/* The Close Button */
.close {
  color: white;
  float: right;
  font-size: 28px;
  font-weight: bold;
}

.close:hover,
.close:focus {
  color: #000;
  text-decoration: none;
  cursor: pointer;
}

.modal-header {
  padding: 1px 5px;
  background-color: red;
  color: white;
  font-size: 28px;
  font-weight: bold;
}

.modal-body {padding: 2px 16px;}
/*
.modal-footer {
  padding: 2px 16px;
  background-color: #5cb85c;
  color: white;
}
*/
</style>
</head>
<body>

<form class="form-horizontal well">
		<legend>
			<h3> <div id="title">XREF Search</div></h3>
		</legend>
		<fieldset>
			<label for="xlf"> <strong>Select ODS, XLSX or CSV File:</strong></label>  
			<input type="file" name="xlfile" id="xlf" />
			<div id="drop">Or drop file here</div>
						<br>
			<div class="filetable">
				<div >
					<label for="sfont"> <strong>Enter Sun font name</strong></label>
					<input id='sfont' onChange='changeFont(true)' type='text' style='width: 50%;'>
					<label for="showerror" style='float: right;'> <strong>Errors Only &nbsp  </strong>
					<!-- <input id='showerr'  onclick='showError()' type='button' >  -->
					<input type="button" id="showerr"  onclick="showError();"  >
				</div>
				<br>
				<div ><label for="xsearch"> <strong>Enter search words separated by space</strong></label>
					<input id='xsearch' onkeyup='search_Table("xref1")' type='text' style='width: 40%;'>
					<label for="xrefclear" style='float: right;'> <strong>Clear &nbsp  </strong>
					<input id='xrefclear'  onclick='clearTable()' type='button' >
				</div>
			</div>
		</fieldset>
	</form>
	
<div><span style="color: #ff0000">Red text</span> indicates a unicode miscompare between font and the unicode.  Click on the line for specifics.
</div>

<pre id="output"></pre>
<footer>
    <center>
      <p>&copy; Wilbur Zirk 2019
	  </p>
    </center>
  </footer>
<!-- The Modal -->
<div id="myModal" class="modal">

  <!-- Modal content -->
  <div class="modal-content">
    <div class="modal-header">
      <span class="close">&times;</span>
      <p>Font Error</p>
    </div>
    <div class="modal-body">
      <p id="mdisp" >Some text in the Modal Body</p>
	</div>
  <!--  <div class="modal-footer">
      <h3>Modal Footer</h3>
    </div>  -->
  </div>

</div>

<script src="js/jszip.js"></script>
<script src="js/xlsx.js"></script>
<script src="js/cookie.js"></script>
<script src="js/table.js"></script>
<script src="js/modal.js"></script>

<script>
var debug = false;

var X = XLSX;
var global_wb;

var colValues =[];

csvData = 'Test Data\n'
+ '"","questioned","e061","mouth,said,speak: ?","ask"\n'
+ '"","ashamed","e05f","no,not: mouth: heart",\n'
+ '"","loaf","e05d","mouth,said,speak: grain,wheat","bread"\n'
+ '"","boy","e001","small,few: man",\n'
+ '"me poss","mine",,,"ours:my:our"\n'
+ '"we poss","ours",,,"mine:my:our"\n'
+ '" ","waist","e391","person",\n'
+ '"","ground","e153",,"land:earth"\n'
+ '"","blaspheme","e05b","mouth,said,speak,confessiom: bad: no,not: good: king,crown,ruler,lord,master: man: love,compassion","insult:blasphemy"\n'
+ '"","Apelles","ebcd","man:split,divide,division,separate","looks_like"\n'
+' "","Levi","eb1b","man: with: equal,same: people",\n';

function getCols(workbook)  { //your workbook variable
    var first_sheet_name = workbook.SheetNames[0];
    var worksheet = workbook.Sheets[first_sheet_name];
    var cells = Object.keys(worksheet);
    for (var i = 0; i < Object.keys(cells).length; i++) {
        if( cells[i].indexOf('1') > -1) {
            colValues.push(worksheet[cells[i]].v); //Contails all column names
        }
    }
	console.log(colValues);
 }

var process_wb = (function() {
	var OUT = document.getElementById('output');
	var to_csv = function to_csv(workbook) {
		var result = [];
		workbook.SheetNames.forEach(function(sheetName) {
			var csv = X.utils.sheet_to_csv(workbook.Sheets[sheetName]);
			if(csv.length){
				result.push("SHEET: " + sheetName);
				result.push("");
				result.push(csv);
			}
		});
		return result.join("\n");
	};


	return function process_wb(wb) {
		global_wb = wb;
		var output = "";
        csv = to_csv(wb);
		//getCols(wb);
		output = csvToArray(csv);
		generateTable(output);
		table_mismatch();
		//sortTable();
	};
})();

var do_file = (function() {
	return function do_file(files) {
		//rABS = domrabs.checked;
		var rABS = false;
		//use_worker = domwork.checked;
		var f = files[0];
		var reader = new FileReader();
		reader.onload = function(e) {
			var data = e.target.result;
			if(!rABS) data = new Uint8Array(data);
			process_wb(X.read(data, {type: rABS ? 'binary' : 'array'}));
		};
		if(rABS) reader.readAsBinaryString(f);
		else reader.readAsArrayBuffer(f);
	};


})();

(function() {
	var drop = document.getElementById('drop');
	if(!drop.addEventListener) return;

	function handleDrop(e) {
		e.stopPropagation();
		e.preventDefault();
		do_file(e.dataTransfer.files);
	}

	function handleDragover(e) {
		e.stopPropagation();
		e.preventDefault();
		e.dataTransfer.dropEffect = 'copy';
	}

	drop.addEventListener('dragenter', handleDragover, false);
	drop.addEventListener('dragover', handleDragover, false);
	drop.addEventListener('drop', handleDrop, false);
})();

(function() {
	var xlf = document.getElementById('xlf');
	if(!xlf.addEventListener) return;
	function handleFile(e) { do_file(e.target.files); }
	xlf.addEventListener('change', handleFile, false);
})();
/*
function generateTable(lines){
	//Clear previous data
	document.getElementById("output").innerHTML = "";
	var table = document.createElement("table");
	table.id = "searchtable";
	table.className = 'xreftable';
	var len = 0;
	for (var i = 0; i < lines.length; i++) {
	  // find longest row
		if (lines[i].length > len) {
			len = lines[i].length;
		}
	}
	
	table.createCaption();
	table.caption.innerHTML = lines[0];
	// make header
	// checkbox in each column header for compare

	var row = document.createElement('TR');
	for (var j = 0; j < len; j++) {
		var th = document.createElement("TH");
		th.onclick = function() {
		sortTable(this.cellIndex); };
		th.appendChild(document.createTextNode('col '+j));
		row.appendChild(th);
	}

	table.appendChild(row);
	var tbody = document.createElement('TBODY');
	for (var i = 1; i < lines.length; i++) {  // get line
		//console.log(lines[i]);
		if (lines[i].length > 1) {	// process row
			var row = document.createElement('TR');
			var mismatch = false;
			var icontext = "";
			var col2text = "";
			for (var j = 0; j < lines[i].length; j++) {
				var text = "";
				var td = document.createElement("TD");
				if (lines[i][j]) text = lines[i][j].trim();
				if (j ===0) {
					//td.className = 'td0';
				}
				td.appendChild(document.createTextNode(text));
				row.appendChild(td);
			}  // end column process
				}	// end row process
		tbody.appendChild(row);
	}  // end process line
	table.appendChild(tbody);
	document.getElementById("output").appendChild(table);

}


function table_mismatch(){
	var chkCols = [];
	var found = false;
	var table = document.getElementById("searchtable");
	var rows = table.getElementsByTagName("tr");

	var rowx = 0;
	for (var i = 3; i < rows.length; i ++) {
		rowx = rows[i]
		console.log(i, rowx.childNodes.length, rowx);
		for (var j = 0;  j < rowx.childNodes.length; j++) {
			var uni = rowx.childNodes[j].innerText.charCodeAt(0).toString(16).toLowerCase();
			if (uni.length == 4) { 
				chkCols[0] = [j, uni];
				found = true;
				break;
			}	
		}
		if (found) break;
	}

	for (var i = 0; i < rowx.childNodes.length; i++) {
		var c0 = rowx.childNodes[i].innerText.toString().toLowerCase();
		if (c0 === chkCols[0][1]) { 
			chkCols[1] = [i, c0];
			break;
		}	
	}

	var fontcol = chkCols[0][0];			// fonticon column
	var unicol = chkCols[1][0];			// unicode column
	var ths = table.getElementsByTagName("th");
	var tds = table.getElementsByTagName("td");
	i = fontcol;
	for (var i = 0; i < ths.length; i++) {
	//i = fontcol;
		if (i === fontcol) {
			ths[i].className = "fonticon";
			ths[i].innerHTML = 'Font';
			//console.log(i, ths[i]);
		}
	//i = unicol;
		if (i === unicol) {
			ths[i].innerHTML = 'Unicode';
			ths[i].className = "unicol";
			//console.log(i, ths[i]);
		}	
	//ths[ths.length-1].className = "width100";
	}
	
	console.log(fontcol, unicol);
	for (i = 1; i < rows.length; i++) {
		var c0 = rows[i].childNodes[fontcol].innerText.charCodeAt(0).toString(16).toLowerCase();
		var c1 = rows[i].childNodes[unicol].innerText.toLowerCase();
	//	var fontname = rows[i].childNodes[1].innerText;
	//	console.log(c0, c1, typeof(c0));
	    rows[i].childNodes[fontcol].className = "fonticon";
		rows[i].childNodes[unicol].className = "unicol";
		//console.log(rows[i].childNodes.length);
		//var len = rows[i].childNodes.length
		//rows[i].childNodes[len - 1].className = "width100";
		if (c0 !== c1) {
			console.log('not equal', fontcol, unicol)
			mismatch = true;	
			var fontname = rows[i].childNodes[1].innerText;
			var errdata = "Font error\nicon = " +c0+"\nunicode = "+c1;
			rows[i].className = "uerror";
			rows[i].setAttribute("rowdata", errdata);
			dispModal(rows[i], chkCols);
		}
	}
*/	
/*
function dispModal(btn, chkCols) {	
			// Get the modal
		var modal = document.getElementById("myModal");
	    
		// Get the button that opens the modal
		//var btn = document.getElementById("myBtn");

		// Get the <span> element that closes the modal
		var span = document.getElementsByClassName("close")[0];

		// When the user clicks the button, open the modal 
		//btn.onclick = function(e) {
		btn.onclick = function(e) {
			modal.style.display = "block";
			var tr = e.target.parentElement;
			console.log(e.target.parentElement);
			var fontcol = chkCols[0][0];			// fonticon column
			var unc = chkCols[1][0];				// unicode column
			var c0 = tr.childNodes[fontcol].innerText.charCodeAt(0).toString(16).toLowerCase();
			var c1 = tr.childNodes[unc].innerText.toLowerCase();
			var errdata = "Font error<br>icon = " +c0+"<br>unicode = "+c1;
			console.log(errdata);
			var mdisp = document.getElementById("mdisp");
			mdisp.innerHTML = errdata;
		}

		// When the user clicks on <span> (x), close the modal
		span.onclick = function() {
		  modal.style.display = "none";
		}

		// When the user clicks anywhere outside of the modal, close it
		window.onclick = function(event) {
		  if (event.target == modal) {
			modal.style.display = "none";
		  }
		}
	} //if modal
}
*/

document.getElementById('sfont').value = "";
document.getElementById('xlf').value = ""; 

console.log(listCookies());
var fnt = cookie.get('font');
if (fnt)  {
	fnt = fnt.replace (/(^")|("$)/g, ''); // remove quotes
	console.log(fnt);
	document.getElementById('sfont').value = fnt;
	changeFont(true);
}

//debug
if (debug) {
	generateTable(csvToArray(csvData));
	table_mismatch();
	//sortTable();
}
	


</script>
</body>
</html>
