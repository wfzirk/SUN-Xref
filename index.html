<!DOCTYPE html>
<!-- xlsx.js (C) 2013-present  SheetJS http://sheetjs.com 
		https://github.com/SheetJS/js-xlsx
		https://stuk.github.io/jszip/
		https://oss.sheetjs.com/js-xlsx/
		https://www.pagecloud.com/blog/how-to-add-custom-fonts-to-any-website
-->
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>Search SUN Spreadsheet</title>
<style>
	@font-face{
	  font-family: "SUN7.24";
	  /*src: url("fonts/SUN7.24.ttf");*/
	}
	
	@font-face {
		font-family: 'sun7.24regular';
		src: url('sun7.24-webfont.woff2') format('woff2'),
			 url('sun7.24-webfont.woff') format('woff');
		font-weight: normal;
		font-style: normal;

	} 
	#output {
		/*background-color: skyblue;
		font-family: var(--sun-font);  */
		font-family: "SUN7.24";
	}
	/*
	:root {
		--sun-font: "SUN7.24";
	}
*/
	
	/*html, select { font-family: Verdana, Geneva, sans-serif, SUN7_24; }
	*/
	body {
		font-family: "SUN7.24";
		width = 600px;
	}
	
	 h3 {	    
		 margin-block-start: .3em;
		 margin-block-end: .3em;
		 margin-inline-start: 0px;
		 margin-inline-end: 0px;
		 text-align: center;
	}


	div.filetable {
		width: 100%
	}	
	
	label#xrefclear {
		float: left;
		width: 30%
	}	
	
	input#xrefclear {
		float: right;
	}	


	table.xreftable {
		 border-width: 1px;
		 border-spacing: 0;
		 border-style: outset;
		 border-color: black;
		 border-collapse: separate; 
	/* 	border-collapse:collapse; */
		 background-color: white; 
		 font-size: 14px;
		/* font-family: var(--sun-font);*/
		 table-layout: fixed;
		 margin-bottom: 15px;
		 width: 100%; 
		 empty-cells: show;
	}

	.unicol{
		width: 50px;
		color: blue;
		border-width: 1px;
		padding: 1px;
		border-style: inset;
		border-color: lightblue;
		font-size: 14px;
		text-align: right; 
	}

	.xreftable td:not(.unicol), .xreftable th:not(.unicol), .xreftable td:not(.fonticon), .xreftable th:not(.fonticon) {
		 border-width: 1px;
		 padding: 1px;
		 border-style: inset;
		 border-color: lightblue;
		 font-size: 14px;
		 text-align: right; 

		white-space: -o-pre-wrap; 
		word-wrap: break-word;
		white-space: pre-wrap; 
		white-space: -moz-pre-wrap; 
		white-space: -pre-wrap; 
		min-width: 50px;
	/*	width: auto;*/
	}

	 .xreftable td.fonticon {
		font-size: 32px;
		/*font-family: var(--sun-font); */
		font-family: "SUN7.24";		
		color: blue;
		border-width: 1px;
		padding: 1px;
		width: 100px;
	}
	 .xreftable th.fonticon {

		color: blue;
		border-width: 1px;
		padding: 1px;
		width: 100px;
	}

	 
		 /*Table Even Rows Styles*/
	 .xreftable tbody, .xreftable tr:nth-child(even){
		 background-color: #efefef;
	 }

		 /*Table ODD Rows Styles*/
	 .xreftable tbody, .xreftable tr:nth-child(odd){
		 background-color: #dfdfdf;
	 }

		 /*Table Row HOver Style*/
	 .xreftable table, .xreftable tbody, .xreftable tr:hover{
		 background-color: #ffffd8;
	 }


	.uerror {
		  color: red;
	 }
	
	 

	#drop{
		border:2px dashed #bbb;
		border-radius:5px;
		padding:5px;
		text-align:center;
		font:20pt bold,"Vollkorn";color:#bbb
	}
	

	/* The Modal (background) */
	.modal {
	  display: none; /* Hidden by default */
	  position: fixed; /* Stay in place */
	  z-index: 1; /* Sit on top */
	  padding-top: 100px; /* Location of the box */
	  left: 0;
	  top: 0;
	  width: 100%; /* Full width */
	  height: 100%; /* Full height */
	  overflow: auto; /* Enable scroll if needed */
	  background-color: rgb(0,0,0); /* Fallback color */
	  background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
	}

	/* Modal Content */
	.modal-content {
	  position: relative;
	  background-color: #fefefe;
	  margin: auto;
	  padding: 0;
	  border: 1px solid #888;
	  border-radius:5px;
	  width: 200px;;
	  box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2),0 6px 20px 0 rgba(0,0,0,0.19);
	  -webkit-animation-name: animatetop;
	  -webkit-animation-duration: 0.4s;
	  animation-name: animatetop;
	  animation-duration: 0.4s
	}

	/* Add Animation */
	@-webkit-keyframes animatetop {
	  from {top:-300px; opacity:0} 
	  to {top:0; opacity:1}
	}

	@keyframes animatetop {
	  from {top:-300px; opacity:0}
	  to {top:0; opacity:1}
	}

	/* The Close Button */
	.close {
	  color: white;
	  float: right;
	  font-size: 28px;
	  font-weight: bold;
	}

	.close:hover,
	.close:focus {
	  color: #000;
	  text-decoration: none;
	  cursor: pointer;
	}

	.modal-header {
	  padding: 1px 5px;
	  background-color: red;
	  color: white;
	  font-size: 28px;
	  font-weight: bold;
	}

	.modal-body {padding: 2px 16px;}

</style>
</head>
<body>

<form class="form-horizontal well">
		<legend>
			<h3> <div id="title">XREF Search</div></h3>
		</legend>
		<fieldset>
			<label for="xlf"> <strong>Select ODS, XLSX or CSV File:</strong></label>  
			<input type="file" name="xlfile" id="xlf" />
			<div id="drop">Or drop file here</div>
						<br>
			<div class="filetable">
				<div >
					<label for="sfont"> <strong>Enter Sun font name</strong></label>
					<input id='sfont' type='text' style='width: 25%;'>
					<!--<input type="file" name="xfile" id="xfont" /> -->SUN7.24
					<label for="showdebug" style='float: right;'> <strong>Debug&nbsp  </strong>
					<input type="checkbox" id="showdebug"  onclick="showDebug();"  >
					<label for="showerror" style='float: right;'> <strong>Errors Only &nbsp  </strong>
					<!-- <input id='showerr'  onclick='showError()' type='button' >  -->
					<input type="button" id="showerr"  onclick="showError();"  >
				</div>
				<br>
				<div ><label for="xsearch"> <strong>Enter search words separated by space</strong></label>
					<input id='xsearch' onkeyup='search_Table("xref1")' type='text' style='width: 40%;'>
					<label for="xrefclear" style='float: right;'> <strong>Clear &nbsp  </strong>
					<input id='xrefclear'  onclick='clearTable()' type='button' >
				</div>
			</div>
		</fieldset>
	</form>
	
<div><span style="color: #ff0000">Red text</span> indicates a unicode miscompare between font and the unicode.  Click on the line for specifics.
</div>
<div>
	<font face = "Times New Roman" size = "5">Times New Roman</font><br />
	<font face = "Verdana" size = "5">Verdana</font><br />
	<font face = "Comic sans MS" size =" 5">Comic Sans MS</font><br />
	<font face = SUN7.24 size = "5">SUN7.24 &#174; &#xe000;   &#57344;</font><br />
</div>  
<font face = "SUN7.24" size = "5">
<div id="output">
SUN7.24 &#174; &#xe000;


&#174; &#xe000;
</font>
</div>
</font>
<footer>
    <center>
      <p>&copy; Wilbur Zirk 2019
	  </p>
    </center>
  </footer>
<!-- The Modal -->
<div id="myModal" class="modal">

  <!-- Modal content -->
  <div class="modal-content">
    <div class="modal-header">
      <span class="close">&times;</span>
      <p>Font Error</p>
    </div>
    <div class="modal-body">
      <p id="mdisp" >Some text in the Modal Body</p>
	</div>
  <!--  <div class="modal-footer">
      <h3>Modal Footer</h3>
    </div>  -->
  </div>

</div>

<script src="js/jszip.js"></script>
<script src="js/xlsx.js"></script>
<!-- <script src="js/cookie.js"></script> -->
<script src="js/table.js"></script>
<script src="js/modal.js"></script>
<script src="js/convertuni.js"></script>

<script>
var debug = false;

var X = XLSX;
var CSV = false;
var global_wb;

var colValues =[];

csvData = 'Test Data\n'
+ '"","questioned","e061","mouth,said,speak: ?","ask"\n'
+ '"","ashamed","e05f","no,not: mouth: heart",\n'
+ '"","loaf","e05d","mouth,said,speak: grain,wheat","bread"\n'
+ '"","boy","e001","small,few: man",\n'
+ '"me poss","mine",,,"ours:my:our"\n'
+ '"we poss","ours",,,"mine:my:our"\n'
+ '" ","waist","e391","person",\n'
+ '"","ground","e153",,"land:earth"\n'
+ '"","blaspheme","e05b","mouth,said,speak,confessiom: bad: no,not: good: king,crown,ruler,lord,master: man: love,compassion","insult:blasphemy"\n'
+ '"","Apelles","ebcd","man:split,divide,division,separate","looks_like"\n'
+ '"","Lud","e1c2","Lud"\n'
+' "","Levi","eb1b","man: with: equal,same: people",\n';

function fixUnicode(lines) {
	console.log('fix');
	for (var i = 0; i < lines.length; i ++) {
		rowx = lines[i]
		//console.log('before',i, rowx.length, rowx);
		//for (var j = 0;  j < rowx.length; j++) {  
			j = 0
			var uni = rowx[j];
			//console.log(toHex(uni), uni.length);
			if (uni.length === 3) {
				var hArry = toHexArray(uni);
				uni = convertUTF82CP(hArry).toLowerCase();
				//console.log( "\\u"+uni);
				var char = unescape('%u' + uni);
				//console.log(char.toString(16));
				lines[i][j] = char;
			}
			//console.log('after',lines[i]);
		//}
	}
	console.log('csvfix',lines);
	return lines;
}

var process_wb = (function() {
	var OUT = document.getElementById('output');
	var to_csv = function to_csv(workbook) {
		var result = [];
		workbook.SheetNames.forEach(function(sheetName) {
			var csv = X.utils.sheet_to_csv(workbook.Sheets[sheetName]);
			//var csv = X.utils.sheet_to_json(workbook.Sheets[sheetName], {header:1, raw:true});
			console.log(csv);
			if(csv.length){
				result.push("SHEET: " + sheetName);
				result.push("");
				result.push(csv);
			}
		});
		return result.join("\n");
	};


	return function process_wb(wb) {
		global_wb = wb;
		var output = "";
        csv = to_csv(wb);
		console.log('csv file',CSV, csv);
		output = csvToArray(csv);
		//console.log(typeof(output), typeof(csv))
		console.log(output)
		if (CSV) output = fixUnicode(output);
		generateTable(output);
		table_mismatch();
		//sortTable();
	};
})();

var do_file = (function() {
	return function do_file(files) {
		//rABS = domrabs.checked;
		var rABS = false;
		//use_worker = domwork.checked;
		var f = files[0];
		//console.log(f);
		var fname = f["name"];
		//document.getElementById('xlf').value = fname;
		var ext = fname.slice((fname.lastIndexOf(".") - 1 >>> 0) + 2).toLowerCase();
		//console.log(ext);
		if (ext === 'csv') CSV = true;
		else CSV = false;
		var reader = new FileReader();
		reader.onload = function(e) {
			var data = e.target.result;
			//if(!rABS) data = new Uint8Array(data);
			console.log(data);
			//process_wb(X.read(data, {type: rABS ? 'binary' : 'array'}));
			process_wb(X.read(data, {type:'array'}));
			//process_wb(X.read(data));
		};
		if(rABS) reader.readAsBinaryString(f);
		else {
			console.log('readasarray');
			reader.readAsArrayBuffer(f);
			//reader.readAsText(f);
		}
	};


})();

(function() {
	var drop = document.getElementById('drop');
	if(!drop.addEventListener) return;

	function handleDrop(e) {
		e.stopPropagation();
		e.preventDefault();
		do_file(e.dataTransfer.files);
	}

	function handleDragover(e) {
		e.stopPropagation();
		e.preventDefault();
		e.dataTransfer.dropEffect = 'copy';
	}

	drop.addEventListener('dragenter', handleDragover, false);
	drop.addEventListener('dragover', handleDragover, false);
	drop.addEventListener('drop', handleDrop, false);
})();

(function() {
	var xlf = document.getElementById('xlf');
	if(!xlf.addEventListener) return;
	function handleFile(e) { do_file(e.target.files); }
	xlf.addEventListener('change', handleFile, false);
})();

(function() {
	var sfont = document.getElementById('sfont');
	if(!sfont.addEventListener) return;
	function handleFile(e) { getFont(); }
	sfont.addEventListener('change', handleFile, false);
})();

(function() {
	var xfont = document.getElementById('xfont');
	if(!xfont.addEventListener) return;
	function handleFile(e) { 
		f = (e.target.files)
		console.log(f)
		var g = f[0]["name"]
		g = g.substring(0, g.lastIndexOf("."))
		
		console.log(g)
		changeFont(g); 
	}
	xfont.addEventListener('change', handleFile, false);
})();

//document.getElementById('sfont').value = "";
document.getElementById('xlf').value = ""; 

var fval = "";
document.getElementById('sfont').value = fval
changeFont("SUN7.24");

function getFont() {
	fval = document.getElementById('sfont').value;
	console.log('getFont',fval)
	//document.documentElement.style.setProperty('--sun-font', fval);
	changeFont(fval)
}

function changeFont(f) {
	//var f = e[0]["name"]
	
	//var fval= f.substring(0, f.lastIndexOf("."))
	
	console.log(f)
	try {
		fval ='"'+f+'"';
		console.log('changefont',fval);
		document.documentElement.style.setProperty('--sun-font', fval);
	} catch {
		alert("Font not found", fval);
	}
	document.getElementById('sfont').value = f;
}
//debug

function showDebug() {
	e =document.getElementById('showdebug').checked;
	console.log(e)
	if (e) {
		generateTable(csvToArray(csvData));
		table_mismatch();
	} else {
		document.getElementById("output").innerHTML = ""
	}
}

if (debug) {
	generateTable(csvToArray(csvData));
	table_mismatch();
	//sortTable();
}
	
/*
var u = ["EE", "AC", "8D"];
console.log(u);
convertUTF82CP(u);
*/
</script>
</body>
</html>
